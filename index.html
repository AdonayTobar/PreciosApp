<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdonayTobar Precios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Contenedor Principal -->
    <div id="app-container" class="w-full max-w-md bg-white shadow-2xl shadow-gray-300 rounded-xl p-8 transition-all duration-300">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <span id="header-title">Inicia Sesión en la Plataforma</span>
        </h1>

        <!-- Mensajes -->
        <div id="message-container" class="hidden px-4 py-3 rounded-md mb-4" role="alert">
            <strong id="message-strong" class="font-bold"></strong>
            <span id="message-text" class="block sm:inline"></span>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden text-center py-6">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 inline-block"></div>
            <p class="mt-2 text-blue-600">Procesando...</p>
        </div>

        <!-- VISTA LOGIN -->
        <div id="login-form-view" class="space-y-4">
            <input type="email" id="login-email" placeholder="Correo Electrónico" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            <input type="password" id="login-password" placeholder="Contraseña" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            <button id="login-btn" class="w-full bg-blue-700 text-white font-semibold py-3 rounded-lg hover:bg-blue-800 transition duration-150 shadow-lg shadow-blue-400/50">
                Iniciar Sesión
            </button>
            <div class="text-center pt-2 text-sm text-gray-600 space-y-2">
                <a href="#" id="forgot-password-link" class="block text-blue-600 hover:text-blue-800 font-medium">¿Olvidaste tu contraseña?</a>
                <p>¿No tienes cuenta?
                    <a href="#" id="go-to-signup-link" class="text-blue-600 hover:text-blue-800 font-medium">Regístrate aquí.</a>
                </p>
            </div>
        </div>

        <!-- VISTA SIGNUP -->
        <div id="signup-form-view" class="space-y-4 hidden">
            <input type="email" id="signup-email" placeholder="Correo Electrónico" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            <input type="password" id="signup-password" placeholder="Contraseña (mínimo 6 caracteres)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            <button id="signup-btn" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-lg shadow-blue-300/50">
                Crear Cuenta
            </button>
            <div class="text-center pt-2 text-sm text-gray-600">
                ¿Ya tienes cuenta?
                <a href="#" id="go-to-login-link-1" class="text-blue-600 hover:text-blue-800 font-medium">Vuelve al Login.</a>
            </div>
        </div>

        <!-- VISTA RESET -->
        <div id="reset-password-view" class="space-y-4 hidden">
            <p class="text-sm text-gray-600 mb-4">Ingresa el correo asociado a tu cuenta para recibir un enlace de restablecimiento.</p>
            <input type="email" id="reset-email" placeholder="Correo Electrónico" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
            <button id="reset-password-btn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition duration-150 shadow-lg shadow-orange-300/50">
                Enviar Enlace
            </button>
            <div class="text-center pt-2 text-sm text-gray-600">
                <a href="#" id="go-to-login-link-2" class="text-blue-600 hover:text-blue-800 font-medium">Volver al Login</a>
            </div>
        </div>

        <!-- VISTA USUARIO AUTENTICADO -->
        <div id="user-view" class="hidden text-center">
            <p class="text-xl font-semibold text-gray-700 mb-4">¡Bienvenido a bordo!</p>
            <p id="user-email-display" class="text-2xl font-bold text-blue-600 mb-6 break-words"></p>
            <div id="verification-status" class="mb-4 p-3 rounded-lg text-sm font-medium"></div>
            <button id="logout-btn" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                Cerrar Sesión
            </button>
        </div>
    </div>

    <!-- ===================== JS COMPLETO ===================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously,
            sendPasswordResetEmail,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcGrB1AUJhchXjNGjBD7s7FnmKchQEZzg",
            authDomain: "adonaytapp.firebaseapp.com",
            projectId: "adonaytapp",
            storageBucket: "adonaytapp.firebasestorage.app",
            messagingSenderId: "141677270435",
            appId: "1:141677270435:web:b7c31e84e7b2d86c297616",
            measurementId: "G-6XDXLLLMN7"
        };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            setLogLevel('debug');
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            displayMessage("Error de configuración de Firebase.", 'error');
        }

        // ===== ELEMENTOS DEL DOM =====
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupBtn = document.getElementById('signup-btn');
        const resetEmailInput = document.getElementById('reset-email');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginFormView = document.getElementById('login-form-view');
        const signupFormView = document.getElementById('signup-form-view');
        const resetPasswordView = document.getElementById('reset-password-view');
        const userView = document.getElementById('user-view');
        const userEmailDisplay = document.getElementById('user-email-display');
        const verificationStatus = document.getElementById('verification-status');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');
        const messageStrong = document.getElementById('message-strong');
        const headerTitle = document.getElementById('header-title');
        const loader = document.getElementById('loader');

        // ===== NAVEGACIÓN =====
        document.getElementById('go-to-signup-link').addEventListener('click', e => { e.preventDefault(); clearMessage(); renderView('signup'); });
        document.getElementById('go-to-login-link-1').addEventListener('click', e => { e.preventDefault(); clearMessage(); renderView('login'); });
        document.getElementById('go-to-login-link-2').addEventListener('click', e => { e.preventDefault(); clearMessage(); renderView('login'); });
        document.getElementById('forgot-password-link').addEventListener('click', e => { e.preventDefault(); clearMessage(); renderView('reset_password'); });

        function renderView(viewName) {
            [loginFormView, signupFormView, resetPasswordView, userView].forEach(v => v.classList.add('hidden'));
            switch (viewName) {
                case 'login': loginFormView.classList.remove('hidden'); headerTitle.textContent = "Inicia Sesión en la Plataforma"; break;
                case 'signup': signupFormView.classList.remove('hidden'); headerTitle.textContent = "Crea tu Cuenta"; break;
                case 'reset_password': resetPasswordView.classList.remove('hidden'); headerTitle.textContent = "Restablece Contraseña"; break;
                case 'authenticated': userView.classList.remove('hidden'); headerTitle.textContent = "¡Sesión Iniciada!"; break;
            }
        }

        function showLoader(isVisible) {
            loader.classList.toggle('hidden', !isVisible);
            if (isVisible) [loginFormView, signupFormView, resetPasswordView, userView].forEach(v => v.classList.add('hidden'));
        }

        function displayMessage(text, type) {
            messageContainer.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700');
            messageText.textContent = text;
            if (type === 'error') {
                messageStrong.textContent = 'Error: ';
                messageContainer.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            } else {
                messageStrong.textContent = 'Éxito: ';
                messageContainer.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            }
        }

        function clearMessage() {
            messageContainer.classList.add('hidden');
            messageText.textContent = '';
            messageStrong.textContent = '';
        }

        function mapFirebaseError(code) {
            switch (code) {
                case 'auth/invalid-email': return 'El formato del correo es incorrecto.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Credenciales incorrectas.';
                case 'auth/weak-password': return 'Contraseña demasiado débil.';
                case 'auth/email-already-in-use': return 'Este correo ya está registrado.';
                default: return 'Error desconocido. (' + code + ')';
            }
        }

        // ===== AUTENTICACIÓN =====
        signupBtn.addEventListener('click', async () => {
            clearMessage();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (!email || !password) return displayMessage("Por favor ingresa correo y contraseña.", 'error');
            showLoader(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                if (userCredential.user) await sendEmailVerification(userCredential.user);
                displayMessage("Cuenta creada. Verifica tu correo antes de iniciar sesión.", 'success');
                renderView('login');
            } catch (error) {
                displayMessage(mapFirebaseError(error.code), 'error');
            } finally {
                showLoader(false);
            }
        });

        loginBtn.addEventListener('click', async () => {
            clearMessage();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) return displayMessage("Por favor ingresa correo y contraseña.", 'error');
            showLoader(true);
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                if (user && !user.emailVerified) {
                    await signOut(auth);
                    throw new Error('auth/email-not-verified');
                }
                displayMessage("Inicio de sesión exitoso. Redirigiendo...", 'success');
                localStorage.setItem('loggedIn', 'true');
                showLoader(false);
                setTimeout(() => window.location.href = "precios.html", 1000);
                return;
            } catch (error) {
                if (error.message === 'auth/email-not-verified')
                    displayMessage("Tu cuenta no está verificada. Revisa tu correo electrónico.", 'error');
                else displayMessage(mapFirebaseError(error.code), 'error');
            } finally {
                showLoader(false);
            }
        });

        resetPasswordBtn.addEventListener('click', async () => {
            clearMessage();
            const email = resetEmailInput.value;
            if (!email) return displayMessage("Ingresa un correo válido.", 'error');
            showLoader(true);
            try {
                await sendPasswordResetEmail(auth, email);
                displayMessage(`Se envió un enlace a "${email}".`, 'success');
                resetEmailInput.value = '';
                renderView('login');
            } catch {
                displayMessage("Ocurrió un error al enviar el enlace.", 'error');
            } finally {
                showLoader(false);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            clearMessage();
            try {
                localStorage.removeItem('loggedIn');
                await signOut(auth);
                displayMessage("Sesión cerrada correctamente.", 'success');
            } catch {
                displayMessage("No se pudo cerrar sesión.", 'error');
            }
        });

        onAuthStateChanged(auth, (user) => {
            loginEmailInput.value = loginPasswordInput.value = signupEmailInput.value = signupPasswordInput.value = resetEmailInput.value = '';
            if (user && user.email) {
                userEmailDisplay.textContent = user.email;
                renderView('authenticated');
                if (user.emailVerified) {
                    verificationStatus.textContent = '✅ Correo verificado.';
                    verificationStatus.className = 'mb-4 p-3 rounded-lg text-sm font-medium bg-green-100 text-green-700';
                } else {
                    verificationStatus.textContent = '⚠️ Correo NO verificado.';
                    verificationStatus.className = 'mb-4 p-3 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700';
                }
            } else renderView('login');
            loader.classList.add('hidden');
        });
    </script>
</body>
</html>
