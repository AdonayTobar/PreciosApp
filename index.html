<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Auth Multi-View</title>

<!-- Carga de Tailwind CSS para estilos -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Fuente Inter de Google */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
body {
  font-family: 'Inter', sans-serif;
  background-color: #f4f7f9;
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
<!-- Contenedor Principal de la Aplicación -->
<div id="app-container" class="w-full max-w-md bg-white shadow-2xl shadow-gray-300 rounded-xl p-8 transition-all duration-300">
  <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
    <span id="header-title">Inicia Sesión en la Plataforma</span>
  </h1>

  <!-- Mensajes (Éxito o Error) -->
  <div id="message-container" class="hidden px-4 py-3 rounded-md mb-4" role="alert">
    <strong id="message-strong" class="font-bold"></strong>
    <span id="message-text" class="block sm:inline"></span>
  </div>

  <!-- Loader simple -->
  <div id="loader" class="hidden text-center py-6">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 inline-block"></div>
    <p class="mt-2 text-blue-600">Procesando...</p>
  </div>

  <!-- ============================================= -->
  <!-- 1. VISTA DE INICIO DE SESIÓN (LOGIN) -->
  <!-- ============================================= -->
  <div id="login-form-view" class="space-y-4">
    <input type="email" id="login-email" placeholder="Correo Electrónico"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
    <input type="password" id="login-password" placeholder="Contraseña"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
    <button id="login-btn"
      class="w-full bg-blue-700 text-white font-semibold py-3 rounded-lg hover:bg-blue-800 transition duration-150 shadow-lg shadow-blue-400/50">
      Iniciar Sesión
    </button>
    <div class="text-center pt-2 text-sm text-gray-600 space-y-2">
      <a href="#" id="forgot-password-link" class="block text-blue-600 hover:text-blue-800 font-medium">¿Olvidaste tu contraseña?</a>
      <p>
        ¿No tienes cuenta?
        <a href="#" id="go-to-signup-link" class="text-blue-600 hover:text-blue-800 font-medium">Regístrate aquí.</a>
      </p>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- 2. VISTA DE CREACIÓN DE CUENTA (SIGNUP) -->
  <!-- ============================================= -->
  <div id="signup-form-view" class="space-y-4 hidden">
    <input type="email" id="signup-email" placeholder="Correo Electrónico"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
    <input type="password" id="signup-password" placeholder="Contraseña (mínimo 6 caracteres)"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
    <button id="signup-btn"
      class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-lg shadow-blue-300/50">
      Crear Cuenta
    </button>
    <div class="text-center pt-2 text-sm text-gray-600">
      ¿Ya tienes cuenta?
      <a href="#" id="go-to-login-link-1" class="text-blue-600 hover:text-blue-800 font-medium">Vuelve al Login.</a>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- 3. VISTA DE RESTABLECER CONTRASEÑA -->
  <!-- ============================================= -->
  <div id="reset-password-view" class="space-y-4 hidden">
    <p class="text-sm text-gray-600 mb-4">Ingresa el correo asociado a tu cuenta para recibir un enlace de restablecimiento.</p>
    <input type="email" id="reset-email" placeholder="Correo Electrónico"
      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
    <button id="reset-password-btn"
      class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition duration-150 shadow-lg shadow-orange-300/50">
      Enviar Enlace
    </button>
    <div class="text-center pt-2 text-sm text-gray-600">
      <a href="#" id="go-to-login-link-2" class="text-blue-600 hover:text-blue-800 font-medium">Volver al Login</a>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- 4. VISTA DE USUARIO AUTENTICADO -->
  <!-- ============================================= -->
  <div id="user-view" class="hidden text-center">
    <p class="text-xl font-semibold text-gray-700 mb-4">¡Bienvenido a bordo!</p>
    <p id="user-email-display" class="text-2xl font-bold text-blue-600 mb-6 break-words"></p>
    <!-- Indicador de verificación de correo -->
    <div id="verification-status" class="mb-4 p-3 rounded-lg text-sm font-medium"></div>
    <!-- Botón de Cerrar Sesión -->
    <button id="logout-btn"
      class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
      Cerrar Sesión
    </button>
  </div>
</div>

<!-- Script de Firebase y Lógica de la App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ==========================================================
// 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
// ==========================================================
const firebaseConfig = {
  apiKey: "AIzaSyAcGrB1AUJhchXjNGjBD7s7FnmKchQEZzg",
  authDomain: "adonaytapp.firebaseapp.com",
  projectId: "adonaytapp",
  storageBucket: "adonaytapp.firebasestorage.app",
  messagingSenderId: "141677270435",
  appId: "1:141677270435:web:b7c31e84e7b2d86c297616",
  measurementId: "G-6XDXLLLMN7"
};

const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
let app;
let auth;

try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  setLogLevel('debug');

  async function handleInitialAuth() {
    try {
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }
    } catch (error) {
      console.error("Error en la autenticación inicial:", error);
    }
  }
  handleInitialAuth();
} catch (e) {
  console.error("Error al inicializar Firebase. Revisa la configuración:", e);
  displayMessage("Error de configuración de Firebase. ¿Están habilitados los servicios?", 'error');
}

// ==========================================================
// 2. ELEMENTOS DEL DOM Y UTILIDADES
// ==========================================================
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const loginBtn = document.getElementById('login-btn');
const signupEmailInput = document.getElementById('signup-email');
const signupPasswordInput = document.getElementById('signup-password');
const signupBtn = document.getElementById('signup-btn');
const resetEmailInput = document.getElementById('reset-email');
const resetPasswordBtn = document.getElementById('reset-password-btn');
const logoutBtn = document.getElementById('logout-btn');

const loginFormView = document.getElementById('login-form-view');
const signupFormView = document.getElementById('signup-form-view');
const resetPasswordView = document.getElementById('reset-password-view');
const userView = document.getElementById('user-view');
const userEmailDisplay = document.getElementById('user-email-display');
const verificationStatus = document.getElementById('verification-status');
const messageContainer = document.getElementById('message-container');
const messageText = document.getElementById('message-text');
const messageStrong = document.getElementById('message-strong');
const headerTitle = document.getElementById('header-title');
const loader = document.getElementById('loader');

// Navegación
document.getElementById('go-to-signup-link').addEventListener('click', (e) => {
  e.preventDefault();
  clearMessage();
  renderView('signup');
});
document.getElementById('go-to-login-link-1').addEventListener('click', (e) => {
  e.preventDefault();
  clearMessage();
  renderView('login');
});
document.getElementById('go-to-login-link-2').addEventListener('click', (e) => {
  e.preventDefault();
  clearMessage();
  renderView('login');
});
document.getElementById('forgot-password-link').addEventListener('click', (e) => {
  e.preventDefault();
  clearMessage();
  renderView('reset_password');
});

function renderView(viewName) {
  [loginFormView, signupFormView, resetPasswordView, userView].forEach(view => view.classList.add('hidden'));
  switch (viewName) {
    case 'login':
      loginFormView.classList.remove('hidden');
      headerTitle.textContent = "Inicia Sesión en la Plataforma";
      break;
    case 'signup':
      signupFormView.classList.remove('hidden');
      headerTitle.textContent = "Crea tu Cuenta";
      break;
    case 'reset_password':
      resetPasswordView.classList.remove('hidden');
      headerTitle.textContent = "Restablece Contraseña";
      break;
    case 'authenticated':
      userView.classList.remove('hidden');
      headerTitle.textContent = "¡Sesión Iniciada!";
      break;
  }
}

function showLoader(isVisible) {
  loader.classList.toggle('hidden', !isVisible);
  if (isVisible) {
    [loginFormView, signupFormView, resetPasswordView, userView].forEach(view => view.classList.add('hidden'));
  }
}

function displayMessage(text, type) {
  messageContainer.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700');
  messageText.textContent = text;
  if (type === 'error') {
    messageStrong.textContent = 'Error: ';
    messageContainer.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
  } else if (type === 'success') {
    messageStrong.textContent = 'Éxito: ';
    messageContainer.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
  }
}

function clearMessage() {
  messageContainer.classList.add('hidden');
  messageText.textContent = '';
  messageStrong.textContent = '';
}

function mapFirebaseError(code) {
  switch (code) {
    case 'auth/invalid-email':
      return 'El formato del correo electrónico es incorrecto.';
    case 'auth/user-not-found':
    case 'auth/wrong-password':
    case 'auth/invalid-credential':
      return 'Credenciales incorrectas. Verifica tu correo electrónico y contraseña e inténtalo de nuevo.';
    case 'auth/weak-password':
      return 'La contraseña debe tener al menos 6 caracteres.';
    case 'auth/email-already-in-use':
      return 'Este correo ya está registrado.';
    case 'auth/missing-email':
      return 'Por favor, ingresa tu correo electrónico.';
    case 'auth/operation-not-allowed':
      return 'La autenticación por correo/contraseña no está habilitada en Firebase.';
    default:
      return 'Ocurrió un error desconocido. Código: ' + code;
  }
}

// ==========================================================
// 3. FUNCIONES DE AUTENTICACIÓN
// ==========================================================
// (El resto del script continúa igual que tu versión original…)
</script>
</body>
</html>

